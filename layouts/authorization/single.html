<!DOCTYPE html>
<html lang="ru">
<head>
  {{ partial "head" . }}
  
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { 
      getAuth, 
      signInWithEmailAndPassword,
      setPersistence,
      createUserWithEmailAndPassword,
      browserSessionPersistence,
      browserLocalPersistence,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    
    // üî• –î–æ–±–∞–≤–ª—è–µ–º –∏–º–ø–æ—Ä—Ç Analytics
    import { getAnalytics, logEvent } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOgF_Ugu3KCqb26VDd1CtRs6dECJK7g4U",
      authDomain: "purecheck.firebaseapp.com",
      projectId: "purecheck",
      storageBucket: "purecheck.firebasestorage.app",
      messagingSenderId: "1077616945405",
      appId: "1:1077616945405:web:02f01694ac5cba34a13694",
      measurementId: "G-BSGH7E645X"
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const analytics = getAnalytics(app); // ‚Üê –í–æ—Ç —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ!
  
    logEvent(analytics, 'page_view', { 
      page_title: document.title,
      page_path: window.location.pathname 
    });

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞—â–∏—â–µ–Ω–Ω—ã—Ö –ø—É—Ç–µ–π
    const protectedPaths = ['/post', '/dashboard']; // –î–æ–±–∞–≤—å—Ç–µ –¥—Ä—É–≥–∏–µ –∑–∞—â–∏—â–µ–Ω–Ω—ã–µ –ø—É—Ç–∏

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π –ø—É—Ç—å
    const isProtectedPath = protectedPaths.some(path => 
      window.location.pathname.startsWith(path)
    );

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω - —Å–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞
        document.querySelector('.auth-container').style.display = 'none';
        
        // –ï—Å–ª–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ - —Ä–µ–¥–∏—Ä–µ–∫—Ç
        if (window.location.pathname === '/auth/') {
          window.location.href = '/';
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞—â–∏—â–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
        document.querySelector('.protected-content').style.display = 'block';
      } else {
        // –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞
        document.querySelector('.auth-container').style.display = 'block';
        
        // –ï—Å–ª–∏ –Ω–∞ –∑–∞—â–∏—â–µ–Ω–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ - —Ä–µ–¥–∏—Ä–µ–∫—Ç
        if (isProtectedPath) {
          window.location.href = '/auth/';
        }
        
        // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞—â–∏—â–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
        document.querySelector('.protected-content').style.display = 'none';
      }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Ö–æ–¥–∞
    async function handleLogin(e) {
      e.preventDefault();
      
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const rememberMe = document.getElementById('remember').checked;
      const errorDiv = document.getElementById('error-message');

      // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ—à–∏–±–∫–∏
      errorDiv.textContent = '';
      errorDiv.style.display = 'none';

      const submitButton = e.target.querySelector('button[type="submit"]');
      const originalText = submitButton.textContent;

      submitButton.disabled = true;
      submitButton.textContent = '–í—Ö–æ–¥...';

      try {
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º persistence (–∑–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏)
        await setPersistence(
          auth,
          rememberMe ? browserLocalPersistence : browserSessionPersistence
        );
        
        // –ü—Ä–æ–±—É–µ–º –≤–æ–π—Ç–∏
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        
        // –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥
        console.log("–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥:", userCredential.user);
        logEvent(analytics, 'login', { 
          method: 'email',
          user_id: userCredential.user.uid 
        });
        
        // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é
        window.location.href = '/';
        
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:", error.code, error.message);
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        let friendlyMessage = '';
        
        switch(error.code) {
          case 'auth/invalid-email':
            friendlyMessage = '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∞–¥—Ä–µ—Å email';
            break;
          case 'auth/user-disabled':
            friendlyMessage = '–≠—Ç–æ—Ç –∞–∫–∫–∞—É–Ω—Ç –±—ã–ª –æ—Ç–∫–ª—é—á–µ–Ω';
            break;
          case 'auth/user-not-found':
            friendlyMessage = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email –Ω–µ –Ω–∞–π–¥–µ–Ω';
            break;
          case 'auth/wrong-password':
            friendlyMessage = '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å';
            break;
          case 'auth/too-many-requests':
            friendlyMessage = '–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ —Å–±—Ä–æ—Å—å—Ç–µ –ø–∞—Ä–æ–ª—å';
            break;
          case 'auth/network-request-failed':
            friendlyMessage = '–ü—Ä–æ–±–ª–µ–º—ã —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º';
            break;
          default:
            friendlyMessage = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞';
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        errorDiv.textContent = friendlyMessage;
        errorDiv.style.display = 'block';
        errorDiv.style.color = '#dc3545';
        errorDiv.style.backgroundColor = '#f8d7da';
        errorDiv.style.padding = '10px';
        errorDiv.style.borderRadius = '4px';
        errorDiv.style.marginTop = '10px';
        errorDiv.style.border = '1px solid #f5c6cb';
        
        // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –≤ –∞–Ω–∞–ª–∏—Ç–∏–∫—É
        logEvent(analytics, 'login_error', {
          error_code: error.code,
          error_message: error.message
        });
      }
      finally{
        submitButton.disabled = false;
        submitButton.textContent = originalText;
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
    document.getElementById('login-form')?.addEventListener('submit', handleLogin);

    // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
    function showError(message) {
      const errorDiv = document.getElementById('error-message');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      setTimeout(() => errorDiv.style.display = 'none', 5000);
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
    document.getElementById('login-form')?.addEventListener('submit', handleLogin);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    async function handleRegister(e) {
      e.preventDefault();
      const email = document.getElementById('reg-email').value;
      const password = document.getElementById('reg-password').value;

      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        
        // --- –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—É—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é —Å –¥–æ–ø. –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ ---
        logEvent(analytics, 'sign_up', {
          method: 'email',
          user_id: userCredential.user.uid, // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
          email_provider: email.split('@')[1], // –Ω–∞–ø—Ä–∏–º–µ—Ä, 'gmail.com'
          signup_time: new Date().toISOString() // –≤—Ä–µ–º—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        });
        
        window.location.href = '/';
      } catch (error) {
        // --- –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ ---
        logEvent(analytics, 'signup_error', {
          error_code: error.code, // 'auth/email-already-in-use'
          error_message: error.message,
          input_email: email // –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö email
        });
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        document.getElementById('error-message-reg').textContent = error.message;
        document.getElementById('error-message-reg').style.display = 'block';
        setTimeout(() => {
          document.getElementById('error-message-reg').style.display = 'none';
        }, 5000);
      }
    }

    // –°–ª—É—à–∞—Ç–µ–ª–∏ —Å–æ–±—ã—Ç–∏–π
    document.getElementById('register-form')?.addEventListener('submit', handleRegister);
  </script>

  <style>
    #error-message {
      display: none;
      padding: 10px;
      background: #ffebee;
      color: #c62828;
      border-radius: 4px;
      margin-top: 15px;
    }
    
    .protected-content {
      display: none;
    }
    
    .auth-only {
      display: none;
    }
    
    :root {
      --primary: #4361ee;
      --primary-dark: #3a0ca3;
      --light: #f8f9fa;
      --white: #ffffff;
      --gray-light: #e9ecef;
      --gray: #adb5bd;
      --dark: #212529;
      --transition: all 0.3s ease;
    }

    .auth-container {
      max-width: 400px;
      margin: 2rem auto;
      padding: 2.5rem;
      border-radius: 12px;
      background: var(--white);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      position: relative;
      overflow: hidden;
    }

    .auth-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--primary);
    }

    .auth-title {
      text-align: center;
      color: var(--dark);
      margin-bottom: 1.8rem;
      font-size: 1.5rem;
      font-weight: 600;
    }

    .input-group {
      margin-bottom: 1.5rem;
    }

    .input-group input {
      width: 100%;
      padding: 0.9rem 1.2rem;
      border: 1px solid var(--gray-light);
      border-radius: 8px;
      font-size: 0.95rem;
      transition: var(--transition);
      background-color: var(--light);
    }

    .input-group input:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
      background-color: var(--white);
    }

    .auth-button {
      width: 100%;
      padding: 0.9rem;
      background: var(--primary);
      color: var(--white);
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
    }

    .auth-button:hover {
      background: var(--primary-dark);
    }
    
    .remember-group {
      display: flex;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    
    .remember-group input {
      width: auto;
      margin-right: 10px;
    }
    
    .remember-group label {
      margin-bottom: 0;
    }
      
    .protected-content {
      display: none;
    }
    
    .auth-container {
      display: none;
    }

    .auth-success {
        background: rgba(67, 97, 238, 0.05);
        border-left: 4px solid var(--primary);
        padding:1rem;
      }
  </style>
</head>

<script>
  window.switchToRegister = function () {
    document.getElementById('login-form').style.display = 'none';
    document.getElementById('register-form').style.display = 'block';
    document.getElementById('auth-title').textContent = '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è';
    document.getElementById('auth-subtitle').textContent = '–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç';
  };

  window.switchToLogin = function () {
    document.getElementById('register-form').style.display = 'none';
    document.getElementById('login-form').style.display = 'block';
    document.getElementById('auth-title').textContent = '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å';
    document.getElementById('auth-subtitle').textContent = '–í–æ–π–¥–∏—Ç–µ –≤ —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç';
  };
</script>

<body class="auth-page">
  {{ partial "header" . }}

  <main class="auth-main">
    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div class="auth-container">
      <div class="auth-header">
        <h1 id="auth-title">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h1>
        <p id="auth-subtitle">–í–æ–π–¥–∏—Ç–µ –≤ —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç</p>
      </div>

      <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
      <form class="auth-form" id="login-form">
        <div class="input-group">
          <label for="email">Email</label>
          <input id="email" type="email" placeholder="your@email.com" required>
        </div>
        <div class="input-group">
          <label for="password">–ü–∞—Ä–æ–ª—å</label>
          <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
        </div>
        <div class="input-group" style="display: flex; align-items: center;">
          <input id="remember" type="checkbox" style="width: auto; margin-right: 10px;">
          <label for="remember" style="margin-bottom: 0;">–ó–∞–ø–æ–º–Ω–∏—Ç—å –º–µ–Ω—è</label>
        </div>
        <button class="auth-button" type="submit">–í–æ–π—Ç–∏</button>
        <p style="text-align:center; margin-top: 1rem;">
          –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="#" onclick="switchToRegister()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
        </p>
        <div id="error-message"></div>
      </form>

      <!-- –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
      <form class="auth-form" id="register-form" style="display:none;">
        <div class="input-group">
          <label for="reg-email">Email</label>
          <input id="reg-email" type="email" placeholder="your@email.com" required>
        </div>
        <div class="input-group">
          <label for="reg-password">–ü–∞—Ä–æ–ª—å</label>
          <input id="reg-password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
        </div>
        <button class="auth-button" type="submit">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
        <p style="text-align:center; margin-top: 1rem;">
          –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a href="#" onclick="switchToLogin()">–í–æ–π—Ç–∏</a>
        </p>
        <div id="error-message-reg"></div>
      </form>
    </div>
    
    <!-- –ó–∞—â–∏—â–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div class="protected-content auth-success">
      <p style="text-align:center; margin-top: 1rem;">
        –í—ã —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã!
      </p>
    </div>
  </main>

  {{ partial "footer" . }}
</body>
</html>