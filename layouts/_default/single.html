{{ define "main" }}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>{{ .Title }} | {{ .Site.Title }}</title>
  <style>
    /* Ваши существующие стили остаются без изменений */
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      line-height: 1.6;
      margin: 0 auto;
      padding: 20px;
    }
    /* ... остальные стили ... */
  </style>
</head>
<body>

<article class="post-content">
  {{ .Content }}
</article>

<div id="auth-status"></div>
<div id="translate-status" style="display:none;"></div>
<button id="translate-btn" style="display:none;">Перевести на English</button>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
  import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';

  const firebaseConfig = {
    apiKey: "AIzaSyBOgF_Ugu3KCqb26VDd1CtRs6dECJK7g4U",
    authDomain: "purecheck.firebaseapp.com",
    projectId: "purecheck",
    storageBucket: "purecheck.appspot.com",
    messagingSenderId: "1077616945405",
    appId: "1:1077616945405:web:02f01694ac5cba34a13694",
    measurementId: "G-BSGH7E645X"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  onAuthStateChanged(auth, (user) => {
    const btn = document.getElementById('translate-btn');
    const authStatus = document.getElementById('auth-status');
    
    if (user) {
      btn.style.display = 'block';
      authStatus.textContent = `Вы вошли как: ${user.email}`;
      authStatus.style.color = '#4CAF50';
    } else {
      btn.style.display = 'none';
      authStatus.textContent = 'Для перевода требуется авторизация';
      authStatus.style.color = '#f44336';
    }
  });

  document.getElementById('translate-btn').addEventListener('click', async function() {
    const btn = this;
    const statusEl = document.getElementById('translate-status');
    
    btn.disabled = true;
    statusEl.style.display = 'block';
    statusEl.innerHTML = '<div class="spinner"></div> Начинаем перевод...';

    try {
      // 1. Определяем правильный URL для API
      const apiUrl = window.location.hostname.includes('localhost') || 
                     window.location.hostname.includes('github.io')
        ? 'https://purecheck.netlify.app/.netlify/functions/translate'
        : '/.netlify/functions/translate';

      // 2. Получаем текст для перевода
      const content = document.querySelector('.post-content').innerText;
      
      // 3. Отправляем запрос
      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text: content.substring(0, 5000) })
      });

      // 4. Проверяем ответ
      const responseText = await response.text();
      let data;
      try {
        data = JSON.parse(responseText);
      } catch {
        throw new Error(`Сервер вернул не JSON: ${responseText.slice(0, 100)}...`);
      }

      if (!response.ok) {
        throw new Error(data.error || "Ошибка сервера");
      }

      // 5. Обновляем контент
      document.querySelector('.post-content').innerHTML = data.translation;
      statusEl.innerHTML = 'Перевод завершён!';
        
    } catch (error) {
      console.error("Ошибка перевода:", error);
      statusEl.innerHTML = `Ошибка: ${error.message}`;
    } finally {
      btn.disabled = false;
      setTimeout(() => statusEl.style.display = 'none', 5000);
    }
  });
</script>
</body>
</html>
{{ end }}